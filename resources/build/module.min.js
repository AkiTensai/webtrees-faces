!function(e){var a=e.mapster.utils;function t(t,o,n,i,c){if(o&&"AREA"===o.nodeName&&"rect"===o.shape){var s=function(e,t,o,n){var i=a.split(e.coords,parseInt),c=i[0],s=i[1],l=i[2],r=i[3],f=l-c,d=n.outerWidth(!0),p=n.outerHeight(!0),u=c+f/2,m=0;u-d/2>0&&(m=u-d/2),u+d/2>t.width&&(m=t.width-d);var b=r;return b+p>t.height&&(b=s-p),[m,b]}(o,n,e(".faces-mapster-wrapper"),t);return t.css({left:s[0]+"px",top:s[1]+"px",opacity:1})}console.error("Unexpected behavior!")}function o(a,t,o,n,i,c){var s=o+".mapster-tooltip";if(e.inArray(t,a)>=0)return n.unbind(s).bind(s,function(e){i&&!i.call(this,e)||(n.unbind(".mapster-tooltip"),c&&c.call(this))}),{object:n,event:s}}e.mapster.AreaData.prototype.showToolTip=function(n,i){var c,s,l,r,f,d=this,p=d.owner,u=d.effectiveOptions();if(i=i?e.extend({},i):{},n=n||u.toolTip,s=i.closeEvents||u.toolTipClose||p.options.toolTipClose||"tooltip-click",f=void 0!==i.template?i.template:p.options.toolTipContainer,i.closeEvents="string"==typeof s?s=a.split(s):s,i.fadeDuration=i.fadeDuration||(p.options.toolTipFade?p.options.fadeDuration||u.fadeDuration:0),l=d.area?d.area:e.map(d.areas(),function(e){return e.area}),p.activeToolTipID!==d.areaId)return p.clearToolTip(),p.activeToolTip=c=function(a,t,o){var n;return t?(n="string"==typeof t?e(t):e(t).clone()).append(a):n=e(a),n.css(e.extend(o||{},{display:"block",position:"absolute",opacity:0})),e(".faces-mapster-wrapper").append(n),n}(n,f,i.css),p.activeToolTipID=d.areaId,r=function(){p.clearToolTip()},o(s,"area-click","click",e(p.map),null,r),o(s,"tooltip-click","click",c,null,r),o(s,"image-mouseout","mouseout",e(p.image),function(e){return e.relatedTarget&&"AREA"!==e.relatedTarget.nodeName&&e.relatedTarget!==d.area},r),t(c,l,p.image,i.container,0),a.ifFunction(p.options.onShowToolTip,d.area,{toolTip:c,options:{},areaOptions:u,key:d.key,selected:d.isSelected()}),c}}(jQuery);var facesMid=null,facesMode="mark",facesIsMobile=null!==new MobileDetect(window.navigator.userAgent).mobile();function facesRoute(e,a){return window.WT_FACES.routes[e].replace("FACES_ACTION",a)}function facesIndex(e){facesMid=e,$.ajax({url:facesRoute("data","index"),type:"GET",data:{mid:e}}).done(function(e){facesRender(e.map,e.edit,e.title,e.meta)})}function facesAttach(e,a,t){$.ajax({url:facesRoute("data","attach"),type:"POST",data:{mid:e,pid:a.pid,coords:a.coords}}).done(function(e){facesRefresh(),t&&null!==e.linker&&$.ajax({url:e.linker.url,type:"POST",data:e.linker.data})})}function facesDetach(e,a){$.ajax({url:facesRoute("data","detach"),type:"POST",data:{mid:e,pid:a.pid}}).done(function(){facesRefresh()})}function facesRefresh(){var e=$.fancybox.getInstance();e.jumpTo(e.currIndex)}function facesClean(){var e=$.fancybox.getInstance().$refs.stage.find(".fancybox-slide--current img.fancybox-image");e.mapster("tooltip"),e.mapster("unbind"),$("#faces-map").remove()}function facesRender(e,a,t,o){var n=$.fancybox.getInstance(),i=n.$refs.caption.find(".fancybox-caption__body"),c=n.$refs.stage.find(".fancybox-slide--current img.fancybox-image");n.$refs.container.toggleClass("faces-readonly",!(a&&!facesIsMobile));var s="faces-map-"+Date.now(),l=$("<map/>",{id:"faces-map",name:s}),r=[],f=[];c.attr("usemap","#"+s).after(l),$.each(e,function(e,t){var o=null!==t.link?t.link:"#",n=encodeURIComponent(t.pid);l.append($("<area/>",{shape:t.coords.length>4?"poly":"rect",coords:t.coords.join(","),href:o,"data-key":n})),r.push({key:n,toolTip:tmpl($("#faces-tooltip-template").html(),{person:t})});var i=tmpl($("#faces-person-template").html(),{person:t,key:n,link:o,edit:a&&!facesIsMobile});f.push(i)}),c.mapster({isSelectable:!1,wrapClass:"faces-mapster-wrapper",mapKey:"data-key",fillColor:"000000",fillOpacity:0,stroke:!0,strokeColor:"3b5998",strokeWidth:2,showToolTip:!0,areas:r,toolTipContainer:'<div class="faces-tooltip"></div>',toolTipClose:facesIsMobile?"area-mouseout":["area-mouseout","image-mouseout"],onClick:facesIsMobile?null:function(e){var a=$(e.e.target).attr("href");return"#"!==a&&(window.location=a),!1}});var d=$("<div>");r.length&&d.html(f.join("")),$.each(o,function(e,a){$.each(a,function(e,a){d.prepend('<div class="faces-subtitle">'+a+"</div>")})}),d.prepend('<div class="faces-title">'+t+"</div>"),i.empty(),i.append(d),facesBindCaptionActions(c,n),facesBindToolbarActions(c,n)}function facesBindCaptionActions(e,a){a.$refs.caption.find(".faces-person-name").on("mouseenter",function(a){e.mapster("highlight",$(a.target).data("key"))}),a.$refs.caption.find(".faces-person-name").on("mouseleave",function(){e.mapster("highlight",!1)}),a.$refs.caption.find(".faces-person-detach").on("click",function(a){var t=$(a.target),o=$(tmpl($("#faces-detach-modal-template").html(),{name:t.data("name")}));o.on("shown.bs.modal",function(){e.mapster("tooltip"),$(".modal-backdrop").before(o)}),o.on("hidden.bs.modal",function(){o.remove()}),o.find("#faces-detach-button").on("click",function(){var e=t.data("pid");e&&facesDetach(facesMid,{pid:e}),o.modal("hide")}),$("body").append(o),o.modal("show")})}function facesBindToolbarActions(e,a){a.$refs.toolbar.find("[data-fancybox-fzoom]").off("click").on("click",function(){alert("TODO: Zoom not implemented yet ;)")}),a.$refs.toolbar.find("[data-fancybox-fconfig]").off("click").on("click",function(){window.location=facesRoute("admin","config")}),a.$refs.toolbar.find("[data-fancybox-fadd]").off("click").on("click",function(){a.$refs.container.toggleClass("faces-select",!0);var t=e.imgAreaSelect({handles:!1,autoHide:!0,show:!0,instance:!0,parent:e.parents(".fancybox-content"),imageHeight:e.get(0).naturalHeight,imageWidth:e.get(0).naturalWidth,onSelectEnd:function(o,n){a.$refs.container.toggleClass("faces-select",!1);var i=$($("#faces-attach-modal-template").html());i.on("shown.bs.modal",function(){e.mapster("tooltip"),$(".modal-backdrop").before(i)}),i.on("hidden.bs.modal",function(){i.remove()}),i.find("select.select2").select2({dropdownParent:i,width:"100%",tags:!0,escapeMarkup:function(e){return e}}),i.find("#faces-attach-button").on("click",function(){var e=i.find("#faces-attach-pid").find(":selected");e.length&&e.val()&&facesAttach(facesMid,{pid:e.val(),coords:[n.x1,n.y1,n.x2,n.y2]},!e.is('[data-select2-tag="true"]')),i.modal("hide")}),$("body").append(i),i.modal("show"),t.cancelSelection(),t.remove()}})})}$.colorbox.remove(),$("body").off("click","a.gallery"),$.fancybox.defaults.btnTpl.fzoom=$.fancybox.defaults.btnTpl.zoom.replace(/zoom/g,"fzoom"),$.fancybox.defaults.btnTpl.fadd=$.fancybox.defaults.btnTpl.close.replace(/close/g,"fadd").replace("{{CLOSE}}","Add"),$.fancybox.defaults.btnTpl.fconfig='<button data-fancybox-fconfig class="fancybox-button fancybox-button--fconfig" title="Settings" style="padding: 14px;"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M507.73 109.1c-2.24-9.03-13.54-12.09-20.12-5.51l-74.36 74.36-67.88-11.31-11.31-67.88 74.36-74.36c6.62-6.62 3.43-17.9-5.66-20.16-47.38-11.74-99.55.91-136.58 37.93-39.64 39.64-50.55 97.1-34.05 147.2L18.74 402.76c-24.99 24.99-24.99 65.51 0 90.5 24.99 24.99 65.51 24.99 90.5 0l213.21-213.21c50.12 16.71 107.47 5.68 147.37-34.22 37.07-37.07 49.7-89.32 37.91-136.73zM64 472c-13.25 0-24-10.75-24-24 0-13.26 10.75-24 24-24s24 10.74 24 24c0 13.25-10.75 24-24 24z"></path></svg></button>',$().fancybox({selector:"a[type^=image].gallery",baseClass:"fancybox-faces-layout",infobar:!1,protect:!1,touch:{vertical:!1},buttons:["close","slideShow","fzoom","fadd","fconfig"],animationEffect:"fade",transitionEffect:"fade",preventCaptionOverlap:!1,idleTime:!1,gutter:0,clickOutside:!1,clickSlide:!1,trapFocus:!1,clickContent:!1,wheel:!1,beforeShow:function(){facesClean()},afterShow:function(e,a){var t=new RegExp("[?&]xref=([^&#]*)").exec(a.src)[1];a.opts.caption='<div class="fancybox-loading"></div>',e.updateControls(),facesIndex(t)},beforeClose:function(){facesClean()}});
