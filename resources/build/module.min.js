!function(e){var o=e.mapster.utils;function a(a,t,n,c,i){if(t&&"AREA"===t.nodeName&&"rect"===t.shape){var s=function(e,a,t,n){var c=o.split(e.coords,parseInt),i=c[0],s=c[1],l=c[2],r=c[3],f=l-i,d=n.outerWidth(!0),p=n.outerHeight(!0),u=i+f/2,m=0;u-d/2>0&&(m=u-d/2),u+d/2>a.width&&(m=a.width-d);var h=r;return console.log("tooltipTop"+h),console.log("tooltipH"+p),console.log("+"+(h+p)),console.log(a.width),h+p>a.height&&(console.log("true"),h=s-p,console.log(h)),[m,h]}(t,n,e(".faces-mapster-wrapper"),a);return a.css({left:s[0]+"px",top:s[1]+"px",opacity:1})}console.error("Unexpected behavior!")}function t(o,a,t,n,c,i){var s=t+".mapster-tooltip";if(e.inArray(a,o)>=0)return n.unbind(s).bind(s,function(e){c&&!c.call(this,e)||(n.unbind(".mapster-tooltip"),i&&i.call(this))}),{object:n,event:s}}e.mapster.AreaData.prototype.showToolTip=function(n,c){var i,s,l,r,f,d=this,p=d.owner,u=d.effectiveOptions();if(c=c?e.extend({},c):{},n=n||u.toolTip,s=c.closeEvents||u.toolTipClose||p.options.toolTipClose||"tooltip-click",f=void 0!==c.template?c.template:p.options.toolTipContainer,c.closeEvents="string"==typeof s?s=o.split(s):s,c.fadeDuration=c.fadeDuration||(p.options.toolTipFade?p.options.fadeDuration||u.fadeDuration:0),l=d.area?d.area:e.map(d.areas(),function(e){return e.area}),p.activeToolTipID!==d.areaId)return p.clearToolTip(),p.activeToolTip=i=function(o,a,t){var n;return a?(n="string"==typeof a?e(a):e(a).clone()).append(o):n=e(o),n.css(e.extend(t||{},{display:"block",position:"absolute",opacity:0})),e(".faces-mapster-wrapper").append(n),n}(n,f,c.css),p.activeToolTipID=d.areaId,r=function(){p.clearToolTip()},t(s,"area-click","click",e(p.map),null,r),t(s,"tooltip-click","click",i,null,r),t(s,"image-mouseout","mouseout",e(p.image),function(e){return e.relatedTarget&&"AREA"!==e.relatedTarget.nodeName&&e.relatedTarget!==d.area},r),a(i,l,p.image,c.container,0),o.ifFunction(p.options.onShowToolTip,d.area,{toolTip:i,options:{},areaOptions:u,key:d.key,selected:d.isSelected()}),i}}(jQuery);var facesMid=null,facesMode="mark",facesTouchMode=null!==new MobileDetect(window.navigator.userAgent).mobile();function facesRoute(e){return window.WT_FACES.routes.data.replace("FACES_ACTION",e)}function facesIndex(e){facesMid=e,$.ajax({url:facesRoute("index"),type:"GET",data:{mid:e}}).done(function(e){facesRender(e.map,e.edit,e.title,e.meta)})}function facesAttach(e,o,a){$.ajax({url:facesRoute("attach"),type:"POST",data:{mid:e,pid:o.pid,coords:o.coords}}).done(function(e){facesRefresh(),a&&null!==e.linker&&$.ajax({url:e.linker.url,type:"POST",data:e.linker.data})})}function facesDetach(e,o){$.ajax({url:facesRoute("detach"),type:"POST",data:{mid:e,pid:o.pid}}).done(function(){facesRefresh()})}function facesRefresh(){var e=$.fancybox.getInstance();e.jumpTo(e.currIndex)}function facesClean(){var e=$.fancybox.getInstance().$refs.stage.find(".fancybox-slide--current img.fancybox-image");e.mapster("tooltip"),e.mapster("unbind"),$("#faces-map").remove()}function facesRender(e,o,a,t){var n=$.fancybox.getInstance(),c=n.$refs.caption.find(".fancybox-caption__body"),i=n.$refs.stage.find(".fancybox-slide--current img.fancybox-image");n.$refs.container.toggleClass("faces-readonly",!(o&&!facesTouchMode));var s="faces-map-"+Date.now(),l=$("<map/>",{id:"faces-map",name:s}),r=[],f=[];i.attr("usemap","#"+s).after(l),$.each(e,function(e,a){var t=null!==a.link?a.link:"#",n=encodeURIComponent(a.pid);l.append($("<area/>",{shape:a.coords.length>4?"poly":"rect",coords:a.coords.join(","),href:t,"data-key":n})),r.push({key:n,toolTip:tmpl($("#faces-tooltip-template").html(),{person:a})});var c=tmpl($("#faces-person-template").html(),{person:a,key:n,link:t,edit:o&&!facesTouchMode});f.push(c)}),i.mapster({isSelectable:!1,wrapClass:"faces-mapster-wrapper",mapKey:"data-key",fillColor:"000000",fillOpacity:0,stroke:!0,strokeColor:"3b5998",strokeWidth:2,showToolTip:!0,areas:r,toolTipContainer:'<div class="faces-tooltip"></div>',toolTipClose:facesTouchMode?"area-mouseout":["area-mouseout","image-mouseout"],onClick:facesTouchMode?null:function(e){var o=$(e.e.target).attr("href");return"#"!==o&&(window.location=o),!1}});var d=$("<div>");r.length&&d.html(f.join("")),$.each(t,function(e,o){$.each(o,function(e,o){d.prepend('<div class="faces-subtitle">'+o+"</div>")})}),d.prepend('<div class="faces-title">'+a+"</div>"),c.empty(),c.append(d),facesBindCaptionActions(i,n),facesBindToolbarActions(i,n)}function facesBindCaptionActions(e,o){o.$refs.caption.find(".faces-person-name").on("mouseenter",function(o){e.mapster("highlight",$(o.target).data("key"))}),o.$refs.caption.find(".faces-person-name").on("mouseleave",function(){e.mapster("highlight",!1)}),o.$refs.caption.find(".faces-person-detach").on("click",function(o){var a=$(o.target),t=$(tmpl($("#faces-detach-modal-template").html(),{name:a.data("name")}));t.on("shown.bs.modal",function(){e.mapster("tooltip"),$(".modal-backdrop").before(t)}),t.on("hidden.bs.modal",function(){t.remove()}),t.find("#faces-detach-button").on("click",function(){var e=a.data("pid");e&&facesDetach(facesMid,{pid:e}),t.modal("hide")}),$("body").append(t),t.modal("show")})}function facesBindToolbarActions(e,o){o.$refs.toolbar.find("[data-fancybox-fzoom]").off("click").on("click",function(){alert("TODO: Zoom not implemented yet ;)")}),o.$refs.toolbar.find("[data-fancybox-fadd]").off("click").on("click",function(){o.$refs.container.toggleClass("faces-select",!0);var a=e.imgAreaSelect({handles:!1,autoHide:!0,show:!0,instance:!0,parent:e.parents(".fancybox-content"),imageHeight:e.get(0).naturalHeight,imageWidth:e.get(0).naturalWidth,onSelectEnd:function(t,n){o.$refs.container.toggleClass("faces-select",!1);var c=$($("#faces-attach-modal-template").html());c.on("shown.bs.modal",function(){e.mapster("tooltip"),$(".modal-backdrop").before(c)}),c.on("hidden.bs.modal",function(){c.remove()}),c.find("select.select2").select2({dropdownParent:c,width:"100%",tags:!0,escapeMarkup:function(e){return e}}),c.find("#faces-attach-button").on("click",function(){var e=c.find("#faces-attach-pid").find(":selected");e.length&&e.val()&&facesAttach(facesMid,{pid:e.val(),coords:[n.x1,n.y1,n.x2,n.y2]},!e.is('[data-select2-tag="true"]')),c.modal("hide")}),$("body").append(c),c.modal("show"),a.cancelSelection(),a.remove()}})})}$.colorbox.remove(),$("body").off("click","a.gallery"),$.fancybox.defaults.btnTpl.fzoom=$.fancybox.defaults.btnTpl.zoom.replace(/zoom/g,"fzoom"),$.fancybox.defaults.btnTpl.fadd=$.fancybox.defaults.btnTpl.close.replace(/close/g,"fadd").replace("{{CLOSE}}","Add"),$().fancybox({selector:"a[type^=image].gallery",baseClass:"fancybox-faces-layout",infobar:!1,protect:!1,touch:{vertical:!1},buttons:["close","slideShow","fzoom","fadd"],animationEffect:"fade",transitionEffect:"fade",preventCaptionOverlap:!1,idleTime:!1,gutter:0,clickOutside:!1,clickSlide:!1,trapFocus:!1,clickContent:!1,wheel:!1,beforeShow:function(){facesClean()},afterShow:function(e,o){var a=new RegExp("[?&]xref=([^&#]*)").exec(o.src)[1];o.opts.caption='<div class="fancybox-loading"></div>',e.updateControls(),facesIndex(a)},beforeClose:function(){facesClean()}});
